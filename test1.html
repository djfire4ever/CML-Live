<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dynamic Product Catalog</title>
<style>
body { font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; margin:20px; background:#f7f7f7; color:#333; }
h1 { margin-bottom:20px; font-weight:600; display:inline-block; }
#cartCounter { margin-left:20px; font-weight:bold; color:#007BFF; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:20px; }
.card { background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); overflow:hidden; cursor:pointer; transition:transform 0.2s,box-shadow 0.2s; }
.card:hover { transform:scale(1.03); box-shadow:0 6px 16px rgba(0,0,0,0.12); }
.card img { width:100%; height:150px; object-fit:cover; }
.card-content { padding:12px; }
.card-content h3 { margin:8px 0 4px; font-size:16px; font-weight:600; }
.card-content p.price { margin:0 0 4px; font-size:14px; font-weight:500; color:#007BFF; }
.card-content p.desc { margin:0; font-size:12px; color:#666; }

/* Modal */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:20px; border-radius:12px; max-width:600px; width:90%; position:relative; display:flex; flex-direction:column; align-items:center; }
.modal img.main { width:100%; height:400px; object-fit:cover; border-radius:8px; background:#f0f0f0; }
.modal h2, .modal p { margin:8px 0 4px; text-align:center; }
.modal p.caption { font-size:12px; color:#555; }
.close { position:absolute; top:10px; right:10px; cursor:pointer; font-size:24px; }
.modal p.caption { min-height:20px; margin:6px 0 0; font-size:12px; color:#555; text-align:center; }

/* Thumbnails */
.modal .thumbnails { display:flex; flex-wrap:wrap; justify-content:center; gap:5px; margin-top:10px; overflow:visible; }
.modal .thumbnails img { width:60px; height:60px; object-fit:cover; border-radius:5px; cursor:pointer; border:2px solid transparent; flex-shrink:0; }
.modal .thumbnails img.active { border-color:#007BFF; }

/* Carousel buttons & Add to Cart */
.carousel-controls { display:flex; justify-content:space-between; width:100%; margin-top:10px; }
.carousel-controls button, #addToCartBtn { padding:5px 12px; font-size:14px; cursor:pointer; }
#addToCartBtn { margin-top:10px; background:#007BFF; color:#fff; border:none; border-radius:5px; }

/* Loader */
.loader { display:none; position:absolute; top:10px; right:10px; font-size:14px; color:#007BFF; }
</style>
</head>
<body>

<h1>Products</h1>
<span id="cartCounter">Cart: 0</span>
<span class="loader" id="loader">Loading...</span>
<div class="grid" id="productGrid"></div>

<!-- Modal -->
<div class="modal" id="productModal">
  <div class="modal-content">
    <span class="close" id="modalClose">&times;</span>

    <!-- carousel stage with overlay buttons -->
    <div class="carousel-stage" id="carouselStage">
      <button class="carousel-btn left" id="prevBtn" aria-label="Previous">&lt;</button>
      <img id="modalImage" class="main" src="" alt="">
      <button class="carousel-btn right" id="nextBtn" aria-label="Next">&gt;</button>
    </div>

    <p class="caption" id="modalCaption"></p>
    <h2 id="modalName"></h2>
    <p id="modalPrice"></p>
    <p id="modalDesc"></p>

    <!-- thumbnails -->
    <div class="thumbnails" id="modalThumbnails"></div>

    <!-- add-to-cart -->
    <button id="addToCartBtn">Add to Cart</button>
  </div>
</div>

<script src="config.js"></script> <!-- this has all my glogal functions, variables and constants including scripturl -->

<script>
let cart = [];
let currentProduct = null;
let currentCarouselIndex = 0;
let autoRotateInterval = null;

const grid = document.getElementById('productGrid');
const modal = document.getElementById('productModal');
const modalImage = document.getElementById('modalImage');
const modalName = document.getElementById('modalName');
const modalPrice = document.getElementById('modalPrice');
const modalDesc = document.getElementById('modalDesc');
const modalCaption = document.getElementById('modalCaption');
const modalThumbnails = document.getElementById('modalThumbnails');
const cartCounter = document.getElementById('cartCounter');
const loader = document.getElementById('loader');

// Fetch gallery for a product
async function fetchGallery(prodID){
  try {
    toggleLoader(true);
    console.log("Fetching gallery for prodID:", prodID);
    const res = await fetch(`${scriptURL}?action=getGalleryByProdId&prodID=${prodID}`);
    const data = await res.json();
    const gallery = data?.success ? data.gallery : { thumbnail:null, images:[] };
    return gallery;
  } catch(err) {
    console.error("Error fetching gallery:", err);
    return { thumbnail:null, images:[] };
  } finally {
    toggleLoader(false);
  }
}

// Fetch all products from backend
async function fetchProducts(){
  try {
    toggleLoader(true);
    const res = await fetch(`${scriptURL}?action=getAllProducts`);
    const data = await res.json();
    return data?.success ? data.products : [];
  } catch(err) {
    console.error("Error fetching products:", err);
    return [];
  } finally {
    toggleLoader(false);
  }
}

// --- Render products dynamically ---
async function renderProducts() {
  const products = await fetchProducts(); // Only products with images per your backend
  grid.innerHTML = "";

  products.forEach(product => {
    // Use thumbnail if available, otherwise fallback to placeholder
    const rawMain = product.thumbnailURL || "/images/No_image_available.svg";
    const mainImage = convertGoogleDriveLink(rawMain);

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <img src="${mainImage}" alt="${product.productName}">
      <div class="card-content">
        <h3>${product.productName}</h3>
        <p class="price">${product.price || ""}</p>
        <p class="desc">${product.description || ""}</p>
      </div>
    `;

    card.onclick = async () => {
      const gallery = await fetchGallery(product.prodID);

      const hasThumbnail = gallery.thumbnail && gallery.thumbnail.url;
      const hasImages = gallery.images && gallery.images.length > 0;

      if (!hasThumbnail && !hasImages) {
        alert("No images available for this product.");
        return;
      }

      openModal(product, gallery);
    };

    grid.appendChild(card);
  });
}

// --- Modal logic ---
function openModal(product, gallery) {
  // Inline normalization
  const slides = [];
  if (gallery) {
    if (gallery.thumbnail && gallery.thumbnail.url) {
      slides.push({ url: convertGoogleDriveLink(gallery.thumbnail.url), caption: gallery.thumbnail.caption || "" });
    }
    if (Array.isArray(gallery.images)) {
      gallery.images.forEach(img => {
        if (!img) return;
        const src = img.url || img.fileUrl || img.src || "";
        if (src) slides.push({ url: convertGoogleDriveLink(src), caption: img.caption || "" });
      });
    }
  }

  currentProduct = { ...product, slides, rawGallery: gallery };
  currentCarouselIndex = 0;
  modal.style.display = "flex";
  renderModal();        // render first slide immediately
  startAutoRotate();    // start auto-rotate
}

// Render modal safely (handles missing captions inline)
function renderModal() {
  const slides = currentProduct?.slides || [];

  if (!slides.length) {
    modalImage.classList.remove("visible");
    modalImage.src = "/images/No_image_available.svg";
    modalCaption.textContent = "";
    modalCaption.classList.remove("has-caption");
    modalName.textContent = currentProduct.productName || "";
    modalPrice.textContent = currentProduct.price || "";
    modalDesc.textContent = currentProduct.description || "";
    modalThumbnails.innerHTML = "";
    return;
  }

  if (currentCarouselIndex >= slides.length) currentCarouselIndex = 0;
  if (currentCarouselIndex < 0) currentCarouselIndex = slides.length - 1;

  const slide = slides[currentCarouselIndex];

  modalImage.classList.remove("visible");
  modalImage.src = slide.url;
  modalImage.onload = () => modalImage.classList.add("visible");

  if (slide.caption && slide.caption.trim().length > 0) {
    modalCaption.textContent = slide.caption;
    modalCaption.classList.add("has-caption");
  } else {
    modalCaption.textContent = "";
    modalCaption.classList.remove("has-caption");
  }

  modalName.textContent = currentProduct.productName || "";
  modalPrice.textContent = currentProduct.price || "";
  modalDesc.textContent = currentProduct.description || "";

  modalThumbnails.innerHTML = "";
  slides.forEach((s, idx) => {
    const t = document.createElement("img");
    t.src = s.url;
    t.alt = s.caption || `${currentProduct.productName} ${idx + 1}`;
    t.className = idx === currentCarouselIndex ? "active" : "";
    t.onclick = () => { currentCarouselIndex = idx; renderModal(); resetAutoRotate(); };
    modalThumbnails.appendChild(t);
  });
}

// --- Carousel controls ---
function nextSlide() {
  const slides = currentProduct?.slides || [];
  if (!slides.length) return;
  currentCarouselIndex = (currentCarouselIndex + 1) % slides.length;
  renderModal();
}

function prevSlide() {
  const slides = currentProduct?.slides || [];
  if (!slides.length) return;
  currentCarouselIndex = (currentCarouselIndex - 1 + slides.length) % slides.length;
  renderModal();
}

function startAutoRotate() {
  stopAutoRotate();
  autoRotateInterval = setInterval(() => {
    const slides = currentProduct?.slides || [];
    if (!slides.length) return;
    nextSlide();
  }, 3000);
}
function stopAutoRotate() {
  if (autoRotateInterval) {
    clearInterval(autoRotateInterval);
    autoRotateInterval = null;
  }
}
function resetAutoRotate() {
  stopAutoRotate();
  startAutoRotate();
}

// --- Pause/resume on hover ---
modal.addEventListener("mouseenter", stopAutoRotate);
modal.addEventListener("mouseleave", startAutoRotate);

// --- Event listeners ---
document.getElementById('nextBtn').onclick = () => { nextSlide(); resetAutoRotate(); };
document.getElementById('prevBtn').onclick = () => { prevSlide(); resetAutoRotate(); };
document.getElementById('modalClose').onclick = () => { modal.style.display = "none"; stopAutoRotate(); };
document.getElementById('addToCartBtn').onclick = () => {
  cart.push({ id: currentProduct.prodID, name: currentProduct.productName, price: currentProduct.price });
  cartCounter.textContent = `Cart: ${cart.length}`;
  alert(`${currentProduct.productName} added to cart!`);
};

// --- Initialize ---
renderProducts();
</script>
</body>
</html>
