<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dynamic Product Catalog</title>
<style>
body { font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; margin:20px; background:#f7f7f7; color:#333; }
h1 { margin-bottom:20px; font-weight:600; display:inline-block; }
#cartCounter { margin-left:20px; font-weight:bold; color:#007BFF; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:20px; }
.card { background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); overflow:hidden; cursor:pointer; transition:transform 0.2s,box-shadow 0.2s; }
.card:hover { transform:scale(1.03); box-shadow:0 6px 16px rgba(0,0,0,0.12); }
.card img { width:100%; height:150px; object-fit:cover; }
.card-content { padding:12px; }
.card-content h3 { margin:8px 0 4px; font-size:16px; font-weight:600; }
.card-content p.price { margin:0 0 4px; font-size:14px; font-weight:500; color:#007BFF; }
.card-content p.desc { margin:0; font-size:12px; color:#666; }

/* Modal */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:20px; border-radius:12px; max-width:600px; width:90%; position:relative; display:flex; flex-direction:column; align-items:center; }
.modal img.main { width:100%; height:400px; object-fit:cover; border-radius:8px; background:#f0f0f0; }
.modal h2, .modal p { margin:8px 0 4px; text-align:center; }
.modal p.caption { font-size:12px; color:#555; }
.close { position:absolute; top:10px; right:10px; cursor:pointer; font-size:24px; }
.modal p.caption { min-height:20px; margin:6px 0 0; font-size:12px; color:#555; text-align:center; }

/* Thumbnails */
.modal .thumbnails { display:flex; flex-wrap:wrap; justify-content:center; gap:5px; margin-top:10px; overflow:visible; }
.modal .thumbnails img { width:60px; height:60px; object-fit:cover; border-radius:5px; cursor:pointer; border:2px solid transparent; flex-shrink:0; }
.modal .thumbnails img.active { border-color:#007BFF; }

/* Carousel buttons & Add to Cart */
.carousel-controls { display:flex; justify-content:space-between; width:100%; margin-top:10px; }
.carousel-controls button, #addToCartBtn { padding:5px 12px; font-size:14px; cursor:pointer; }
#addToCartBtn { margin-top:10px; background:#007BFF; color:#fff; border:none; border-radius:5px; }

/* Loader */
.loader { display:none; position:absolute; top:10px; right:10px; font-size:14px; color:#007BFF; }
</style>
</head>
<body>

<h1>Products</h1>
<span id="cartCounter">Cart: 0</span>
<span class="loader" id="loader">Loading...</span>
<div class="grid" id="productGrid"></div>

<!-- Modal -->
<div class="modal" id="productModal">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <span class="close" id="modalClose">&times;</span>

      <!-- Carousel -->
      <div id="productCarousel" class="carousel slide bg-dark" data-bs-ride="carousel">
        <div class="carousel-indicators" id="carouselIndicators">
          <!-- indicators injected dynamically -->
        </div>
        <div class="carousel-inner" id="carouselInner">
          <!-- slides injected dynamically -->
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Next</span>
        </button>
      </div>

      <!-- product info -->
      <div class="p-3 text-center">
        <h2 id="modalName"></h2>
        <p id="modalPrice"></p>
        <p id="modalDesc"></p>
        <button id="addToCartBtn" class="btn btn-primary">Add to Cart</button>
      </div>
    </div>
  </div>
</div>

<script src="config.js"></script> <!-- this has all my glogal functions, variables and constants including scripturl -->

<script>
let cart = [];
let currentProduct = null;
let currentCarouselIndex = 0;
let autoRotateInterval = null;

const grid = document.getElementById('productGrid');
const modal = document.getElementById('productModal');
const modalImage = document.getElementById('modalImage');
const modalName = document.getElementById('modalName');
const modalPrice = document.getElementById('modalPrice');
const modalDesc = document.getElementById('modalDesc');
const modalCaption = document.getElementById('modalCaption');
const modalThumbnails = document.getElementById('modalThumbnails');
const cartCounter = document.getElementById('cartCounter');
const loader = document.getElementById('loader');

// Fetch gallery for a product
async function fetchGallery(prodID){
  try {
    toggleLoader(true);
    console.log("Fetching gallery for prodID:", prodID);
    const res = await fetch(`${scriptURL}?action=getGalleryByProdId&prodID=${prodID}`);
    const data = await res.json();
    const gallery = data?.success ? data.gallery : { thumbnail:null, images:[] };
    return gallery;
  } catch(err) {
    console.error("Error fetching gallery:", err);
    return { thumbnail:null, images:[] };
  } finally {
    toggleLoader(false);
  }
}

// Fetch all products from backend
async function fetchProducts(){
  try {
    toggleLoader(true);
    const res = await fetch(`${scriptURL}?action=getAllProducts`);
    const data = await res.json();
    return data?.success ? data.products : [];
  } catch(err) {
    console.error("Error fetching products:", err);
    return [];
  } finally {
    toggleLoader(false);
  }
}

// --- Render products dynamically ---
async function renderProducts() {
  const products = await fetchProducts(); // Only products with images per your backend
  grid.innerHTML = "";

  products.forEach(product => {
    // Use thumbnail if available, otherwise fallback to placeholder
    const rawMain = product.thumbnailURL || "/images/No_image_available.svg";
    const mainImage = convertGoogleDriveLink(rawMain);

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <img src="${mainImage}" alt="${product.productName}">
      <div class="card-content">
        <h3>${product.productName}</h3>
        <p class="price">${product.price || ""}</p>
        <p class="desc">${product.description || ""}</p>
      </div>
    `;

    card.onclick = async () => {
      const gallery = await fetchGallery(product.prodID);

      const hasThumbnail = gallery.thumbnail && gallery.thumbnail.url;
      const hasImages = gallery.images && gallery.images.length > 0;

      if (!hasThumbnail && !hasImages) {
        alert("No images available for this product.");
        return;
      }

      openModal(product, gallery);
    };

    grid.appendChild(card);
  });
}

// --- Modal logic ---
function openModal(product, gallery) {
  // Inline normalization
  const slides = [];
  if (gallery) {
    if (gallery.thumbnail && gallery.thumbnail.url) {
      slides.push({ url: convertGoogleDriveLink(gallery.thumbnail.url), caption: gallery.thumbnail.caption || "" });
    }
    if (Array.isArray(gallery.images)) {
      gallery.images.forEach(img => {
        if (!img) return;
        const src = img.url || img.fileUrl || img.src || "";
        if (src) slides.push({ url: convertGoogleDriveLink(src), caption: img.caption || "" });
      });
    }
  }

  currentProduct = { ...product, slides, rawGallery: gallery };
  currentCarouselIndex = 0;
  modal.style.display = "flex";
  renderModal();        // render first slide immediately
  startAutoRotate();    // start auto-rotate
}

// Render modal safely (handles missing captions inline)
function renderModal() {
  if (!currentProduct || !currentProduct.images || !currentProduct.images.length) return;

  const modal = document.getElementById('productModal');
  const carouselInner = document.getElementById('carouselInner');
  const carouselIndicators = document.getElementById('carouselIndicators');
  const modalName = document.getElementById('modalName');
  const modalPrice = document.getElementById('modalPrice');
  const modalDesc = document.getElementById('modalDesc');

  // Clear previous slides
  carouselInner.innerHTML = '';
  carouselIndicators.innerHTML = '';

  // Build slides and indicators dynamically
  currentProduct.images.forEach((img, idx) => {
    // Slide
    const slideDiv = document.createElement('div');
    slideDiv.classList.add('carousel-item');
    if (idx === 0) slideDiv.classList.add('active');

    const imageEl = document.createElement('img');
    imageEl.src = convertGoogleDriveLink(img.url || '');
    imageEl.classList.add('d-block', 'w-100');
    imageEl.alt = img.caption || `Slide ${idx + 1}`;
    imageEl.style.height = '400px'; // fixed height
    imageEl.style.objectFit = 'cover';

    slideDiv.appendChild(imageEl);

    // Caption (optional)
    if (img.caption) {
      const captionDiv = document.createElement('div');
      captionDiv.classList.add('carousel-caption', 'd-none', 'd-md-block');
      const captionTitle = document.createElement('h5');
      captionTitle.textContent = img.caption;
      captionDiv.appendChild(captionTitle);
      slideDiv.appendChild(captionDiv);
    }

    carouselInner.appendChild(slideDiv);

    // Indicator
    const indicatorBtn = document.createElement('button');
    indicatorBtn.type = 'button';
    indicatorBtn.setAttribute('data-bs-target', '#productCarousel');
    indicatorBtn.setAttribute('data-bs-slide-to', idx);
    indicatorBtn.setAttribute('aria-label', `Slide ${idx + 1}`);
    if (idx === 0) {
      indicatorBtn.classList.add('active');
      indicatorBtn.setAttribute('aria-current', 'true');
    }
    carouselIndicators.appendChild(indicatorBtn);
  });

  // Set product info
  modalName.textContent = currentProduct.productName || '';
  modalPrice.textContent = currentProduct.price ? `$${currentProduct.price}` : '';
  modalDesc.textContent = currentProduct.desc || '';

  // Show modal
  modal.style.display = 'flex';

  // Initialize Bootstrap carousel instance
  const carouselEl = document.getElementById('productCarousel');
  const bsCarousel = bootstrap.Carousel.getInstance(carouselEl) || new bootstrap.Carousel(carouselEl, { interval: 3000, ride: 'carousel' });

  // Optional: reset to first slide
  bsCarousel.to(0);
}

// --- Carousel controls ---
function nextSlide() {
  const slides = currentProduct?.slides || [];
  if (!slides.length) return;
  currentCarouselIndex = (currentCarouselIndex + 1) % slides.length;
  renderModal();
}

function prevSlide() {
  const slides = currentProduct?.slides || [];
  if (!slides.length) return;
  currentCarouselIndex = (currentCarouselIndex - 1 + slides.length) % slides.length;
  renderModal();
}

function startAutoRotate() {
  stopAutoRotate();
  autoRotateInterval = setInterval(() => {
    const slides = currentProduct?.slides || [];
    if (!slides.length) return;
    nextSlide();
  }, 3000);
}
function stopAutoRotate() {
  if (autoRotateInterval) {
    clearInterval(autoRotateInterval);
    autoRotateInterval = null;
  }
}
function resetAutoRotate() {
  stopAutoRotate();
  startAutoRotate();
}

// --- Pause/resume on hover ---
modal.addEventListener("mouseenter", stopAutoRotate);
modal.addEventListener("mouseleave", startAutoRotate);

// --- Event listeners ---
document.getElementById('nextBtn').onclick = () => { nextSlide(); resetAutoRotate(); };
document.getElementById('prevBtn').onclick = () => { prevSlide(); resetAutoRotate(); };
document.getElementById('modalClose').onclick = () => { modal.style.display = "none"; stopAutoRotate(); };
document.getElementById('addToCartBtn').onclick = () => {
  cart.push({ id: currentProduct.prodID, name: currentProduct.productName, price: currentProduct.price });
  cartCounter.textContent = `Cart: ${cart.length}`;
  alert(`${currentProduct.productName} added to cart!`);
};

// --- Initialize ---
renderProducts();
</script>
</body>
</html>
