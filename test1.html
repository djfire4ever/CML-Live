<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dynamic Product Catalog</title>

<style>
body { font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; margin:20px; background:#f7f7f7; color:#333; }
h1 { margin-bottom:20px; font-weight:600; display:inline-block; }
#cartCounter { margin-left:20px; font-weight:bold; color:#007BFF; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:20px; }
.card { background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); overflow:hidden; cursor:pointer; transition:transform 0.2s, box-shadow 0.2s; }
.card:hover { transform:scale(1.03); box-shadow:0 6px 16px rgba(0,0,0,0.12); }
.card img { width:100%; height:150px; object-fit:cover; }
.card-content { padding:12px; }
.card-content h3 { margin:8px 0 4px; font-size:16px; font-weight:600; }
.card-content p.price { margin:0 0 4px; font-size:14px; font-weight:500; color:#007BFF; }
.card-content p.desc { margin:0; font-size:12px; color:#666; }

#productModal.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
#productModal .modal-content { background:#fff; padding:20px; border-radius:12px; max-width:700px; width:90%; position:relative; display:flex; flex-direction:column; align-items:center; }
#productModal .carousel-wrapper { position:relative; width:400px; height:400px; display:flex; justify-content:center; align-items:center; background:#f0f0f0; margin-bottom:10px; }
#productModal img.main { width:400px; height:400px; object-fit:contain; display:block; border-radius:8px; }
#productModal .carousel-btn { position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:#fff; border:none; font-size:24px; padding:8px 12px; cursor:pointer; border-radius:4px; z-index:10; }
#productModal .prev-btn { left:5px; }
#productModal .next-btn { right:5px; }
#productModal .caption { min-height:20px; margin:6px 0 10px; font-size:14px; color:#555; text-align:center; }
#productModal .thumbnails { display:flex; justify-content:center; gap:5px; margin-bottom:10px; flex-wrap:nowrap; }
#productModal .thumbnails img { flex:1 1 calc((100% - 6*5px)/7); max-width:60px; height:60px; object-fit:cover; border-radius:5px; cursor:pointer; border:2px solid transparent; transition:transform 0.2s ease, border-color 0.2s ease; }
#productModal .thumbnails img:hover { transform:scale(1.1); border-color:#007BFF; }
#productModal .thumbnails img.active { border-color:#007BFF; }
#productModal #modalName, #productModal #modalPrice, #productModal #modalDesc { text-align:center; margin:4px 0; }
#productModal #addToCartBtn { margin-top:10px; background:#007BFF; color:#fff; border:none; border-radius:5px; padding:8px 14px; cursor:pointer; }
#productModal .close { position:absolute; top:10px; right:10px; cursor:pointer; font-size:24px; }

/* Global skeleton styling */
.skeleton { background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%); background-size:200% 100%; animation:shimmer 1.5s infinite; border-radius:8px; }
.skeleton-card { width:100%; height:150px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); margin-bottom:8px; }
.skeleton-thumb { width:60px; height:60px; border-radius:5px; margin:2px; }
.skeleton-modal { width:400px; height:400px; border-radius:8px; margin-bottom:10px; }
@keyframes shimmer {0%{background-position:-200% 0;}100%{background-position:200% 0;}}
.card.skeleton-card {width:100%;height:150px;margin-bottom:8px;border-radius:12px;overflow:hidden;position:relative;background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;display:flex;flex-direction:column;justify-content:flex-start;}
.card.skeleton-card .skeleton-img {width:100%;height:90px;background:#ddd;margin-bottom:8px;border-radius:8px;}
.card.skeleton-card .skeleton-title {width:60%;height:14px;background:#ddd;margin:0 0 4px;border-radius:4px;}
.card.skeleton-card .skeleton-price {width:40%;height:12px;background:#ddd;margin:0 0 4px;border-radius:4px;}
.card.skeleton-card .skeleton-desc {width:80%;height:10px;background:#ddd;border-radius:4px;}

.modal .modal-loader { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); display:flex; justify-content:center; align-items:center; z-index:1000; }
#modalLoader { position:absolute; top:0; left:0; width:100%; height:100%; display:none; justify-content:center; align-items:center; z-index:1050; background:rgba(255,255,255,0); pointer-events:auto; }
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
</style>

</head>
<body>

<h1>Products</h1>
<span id="cartCounter">Cart: 0</span>
<div class="grid" id="productGrid"></div>

<!-- Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content position-relative">
      <span class="close" id="modalClose">&times;</span>

      <!-- Bootstrap Carousel -->
      <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-indicators" id="carouselIndicators"></div>
        <div class="carousel-inner" id="carouselInner"></div>
        <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon"></span>
          <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon"></span>
          <span class="visually-hidden">Next</span>
        </button>
      </div>

      <div class="thumbnails d-flex justify-content-center flex-wrap mt-2" id="carouselThumbnails"></div>

      <div class="text-center mt-3">
        <h2 id="modalName"></h2>
        <p id="modalPrice"></p>
        <p id="modalDesc"></p>
        <button id="addToCartBtn" class="btn btn-primary mt-2">Add to Cart</button>
      </div>
    </div>
  </div>
</div>

<script src="config.js"></script> <!-- this has all my glogal functions, variables and constants including scripturl -->

<script>
let cart = [];
let currentProduct = null;
let autoRotateInterval = null;

document.addEventListener('DOMContentLoaded', () => {
  const grid = document.getElementById('productGrid');
  const modal = document.getElementById('productModal');
  const modalName = document.getElementById('modalName');
  const modalPrice = document.getElementById('modalPrice');
  const modalDesc = document.getElementById('modalDesc');
  const carouselInner = document.getElementById('carouselInner');
  const carouselIndicators = document.getElementById('carouselIndicators');
  const carouselThumbnails = document.getElementById('carouselThumbnails');
  const addToCartBtn = document.getElementById('addToCartBtn');
  const modalClose = document.getElementById('modalClose');
  const cartCounter = document.getElementById('cartCounter');

  // Close modal
  modalClose.onclick = () => { bootstrap.Modal.getInstance(modal)?.hide(); stopAutoRotate(); };

  // Add to cart
  addToCartBtn.onclick = () => {
    if (!currentProduct) return;
    cart.push({ id: currentProduct.prodID, name: currentProduct.productName, price: currentProduct.price });
    cartCounter.textContent = `Cart: ${cart.length}`;
    alert(`${currentProduct.productName} added to cart!`);
  };

  // Fetch products
  async function fetchProducts() {
    try {
      const res = await fetch(`${scriptURL}?action=getAllProducts`);
      const data = await res.json();
      return data?.success ? data.products : [];
    } catch (err) { console.error(err); return []; }
  }

  // Fetch gallery
  async function fetchGallery(prodID) {
    try {
      const res = await fetch(`${scriptURL}?action=getGalleryByProdId&prodID=${prodID}`);
      const data = await res.json();
      return data?.success ? data.gallery : { thumbnail:null, images:[] };
    } catch (err) { console.error(err); return { thumbnail:null, images:[] }; }
  }

  // Render product grid with skeletons
async function renderProducts() {
  grid.innerHTML = '';
  const skeletonCount = 6;
  for (let i = 0; i < skeletonCount; i++) {
    const sk = document.createElement('div');
    sk.className = 'card skeleton-card';
    sk.innerHTML = `
      <div class="skeleton-img"></div>
      <div class="skeleton-title"></div>
      <div class="skeleton-price"></div>
      <div class="skeleton-desc"></div>
    `;
    grid.appendChild(sk);
  }

  const products = await fetchProducts();
  grid.innerHTML = '';

  if (!products.length) {
    grid.innerHTML = '<p class="text-center text-muted">No products available</p>';
    return;
  }

  products.forEach(product => {
    if (!product.thumbnailURL) return;
    const mainImage = convertGoogleDriveLink(product.thumbnailURL);
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <img src="${mainImage}" alt="${product.productName}">
      <div class="card-content">
        <h3>${product.productName}</h3>
        <p class="price">${product.price || ''}</p>
        <p class="desc">${product.description || ''}</p>
      </div>
    `;
    card.onclick = () => {
      openModal(product, null);
      fetchGallery(product.prodID).then(gallery => {
        if (!gallery?.images?.length) {
          carouselInner.innerHTML = '<div class="p-5 text-center text-muted">No images available</div>';
          return;
        }
        currentProduct = { ...product, gallery };
        renderCarousel();
        startAutoRotate();
      });
    };
    grid.appendChild(card);
  });
}

  // Open modal with skeleton
  function openModal(product, gallery) {
    carouselInner.innerHTML = '';
    carouselIndicators.innerHTML = '';
    carouselThumbnails.innerHTML = '';
    modalName.textContent = product.productName || '';
    modalPrice.textContent = product.price ? `$${product.price}` : '';
    modalDesc.textContent = product.description || '';

    const skMain = document.createElement('div');
    skMain.className = 'skeleton';
    carouselInner.appendChild(skMain);
    for (let i = 0; i < 3; i++) {
      const sk = document.createElement('div');
      sk.className = 'skeleton-thumb';
      carouselThumbnails.appendChild(sk);
    }

    new bootstrap.Modal(modal).show();
  }

  // Render carousel
  function renderCarousel() {
    carouselInner.innerHTML = '';
    carouselIndicators.innerHTML = '';
    carouselThumbnails.innerHTML = '';

    if (!currentProduct?.gallery?.images?.length) {
      carouselInner.innerHTML = '<div class="p-5 text-center text-muted">No images available</div>';
      return;
    }

    const carouselEl = document.getElementById('productCarousel');
    const bsCarousel = bootstrap.Carousel.getOrCreateInstance(carouselEl, { interval: 3000, wrap: true });

    currentProduct.gallery.images.forEach((img, i) => {
      const item = document.createElement('div');
      item.className = `carousel-item ${i === 0 ? 'active' : ''}`;
      const slideImg = document.createElement('img');
      slideImg.src = convertGoogleDriveLink(img.url);
      slideImg.className = 'd-block w-100';
      slideImg.style.width = '400px';
      slideImg.style.height = '400px';
      slideImg.style.objectFit = 'contain';
      item.appendChild(slideImg);

      if (img.caption) {
        const captionDiv = document.createElement('div');
        captionDiv.className = 'carousel-caption d-none d-md-block';
        const captionH5 = document.createElement('h5');
        captionH5.textContent = img.caption;
        captionDiv.appendChild(captionH5);
        item.appendChild(captionDiv);
      }

      carouselInner.appendChild(item);

      const ind = document.createElement('button');
      ind.setAttribute('data-bs-target', '#productCarousel');
      ind.setAttribute('data-bs-slide-to', i);
      ind.setAttribute('aria-label', `Slide ${i+1}`);
      if (i === 0) ind.classList.add('active');
      carouselIndicators.appendChild(ind);

      const thumb = document.createElement('img');
      thumb.src = convertGoogleDriveLink(img.url);
      thumb.style.width = '60px';
      thumb.style.height = '60px';
      thumb.style.objectFit = 'cover';
      thumb.style.cursor = 'pointer';
      thumb.style.margin = '2px';
      thumb.style.flex = '0 0 auto';
      if (i === 0) thumb.style.border = '2px solid #007BFF';
      thumb.onclick = () => {
        document.querySelectorAll('#carouselThumbnails img').forEach(t => t.style.border = '2px solid transparent');
        thumb.style.border = '2px solid #007BFF';
        bsCarousel.to(i);
      };
      carouselThumbnails.appendChild(thumb);
    });
  }

  // Auto-rotate
  function startAutoRotate() {
    stopAutoRotate();
    const bsCarousel = bootstrap.Carousel.getInstance(document.getElementById('productCarousel'));
    if (!bsCarousel) return;
    autoRotateInterval = setInterval(()=>bsCarousel.next(),3000);
  }
  function stopAutoRotate() {
    if (autoRotateInterval){ clearInterval(autoRotateInterval); autoRotateInterval=null; }
  }
  modal.addEventListener('mouseenter', stopAutoRotate);
  modal.addEventListener('mouseleave', startAutoRotate);

  renderProducts();
});
</script>

</body>
</html>
