<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secure File Upload</title>
<style>
  /* Outer page container */
  .page-container {
    border: 0;
    border-radius: 12px;
    padding: 2rem;
    max-width: 1200px;
    width: 90%;
    margin: 3rem auto;
    background-color: var(--bs-black);
    color: var(--bs-info);
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
  }

  /* Greeting */
  #greeting {
    margin-bottom: 2rem;
  }
  #greeting span:first-child {
    font-weight: bold;
    font-size: 1.8rem;
    display: block;
    margin-bottom: 0.2rem;
  }
  #greeting span:last-child {
    font-size: 1rem;
    display: block;
    margin-top: 0.2rem;
    color: var(--bs-info);
  }

  /* Inner upload section */
  .upload-section {
    border: 2px solid var(--bs-info);
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
    background-color: var(--bs-black);
    width: 100%;
    box-sizing: border-box;
  }

  /* File items */
  .file-item { 
    margin-bottom: 1.8rem; 
    padding: 1rem; 
    background-color: var(--bs-black);
    border-radius: 8px;
    box-shadow: inset 0 0 10px rgba(255,255,255,0.05);
    transition: transform 0.2s ease;
  }
  .file-item:hover { transform: translateY(-2px); }
  .file-item label { font-weight: bold; display: block; margin-bottom: 0.3rem; }
  .note-label { margin-top: 0.5rem; display: block; font-style: italic; color: var(--bs-info); }

  /* File input styling */
  input[type="file"] {
    background-color: var(--bs-black);
    color: var(--bs-info);
    border: 1px solid var(--bs-info);
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    width: 100%;
    cursor: pointer;
    transition: background-color 0.2s, color 0.2s;
  }
  input[type="file"]:hover,
  input[type="file"]:focus {
    background-color: rgba(255,255,255,0.05);
    outline: none;
  }
  input[type="file"]::file-selector-button {
    background-color: var(--bs-black);
    color: var(--bs-info);
    border: 1px solid var(--bs-info);
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s, color 0.2s;
  }
  input[type="file"]::file-selector-button:hover {
    background-color: rgba(255,255,255,0.05);
  }

  /* Progress bar */
  .progress {
    height: 22px; 
    margin-top: 0.5rem;
    border-radius: 6px;
    background-color: rgba(255,255,255,0.1);
  }
  .progress-bar {
    background-color: var(--bs-info) !important;
    font-weight: bold;
    color: var(--bs-black);
  }

  /* Buttons */
  #uploadBtn, #addFileBtn {
    border-radius: 6px;
    padding: 0.5rem 1.25rem;
    font-weight: bold;
    transition: transform 0.15s, box-shadow 0.15s;
  }
  #uploadBtn:hover, #addFileBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
  #uploadBtn:disabled { opacity: 0.6; cursor: not-allowed; }

  .text-center { text-align: center; }

  /* Responsive adjustments */
  @media(max-width:768px){
    .page-container { width: 95%; padding: 1.5rem; }
    .upload-section { padding: 1.5rem; }
  }
</style>
</head>
<body class="page-body" style="min-height: 100vh;" data-element="page-bg">
<div class="watermark"></div>
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

<!-- Loader -->
<div id="loadingOverlay" class="d-none">
  <div class="text-center">
    <div class="spinner-border" role="status"></div>
    <p class="mt-4">Uploading files... Please wait...</p>
  </div>
</div>

<!-- Page container -->
<div class="page-container">

  <!-- Greeting -->
  <h3 id="greeting">
    <span>Hi there,</span>
    <span>Please upload up to 3 files. You may add a note for each file.</span>
  </h3>

  <!-- Upload section -->
  <div class="upload-section">
    <div id="fileContainer"></div>
    <button id="addFileBtn" class="btn btn-secondary mb-3">Add File</button>
  </div>

  <!-- Upload button -->
  <div class="text-center mt-3">
    <button id="uploadBtn" class="btn btn-primary" disabled>Upload Files</button>
  </div>

</div>

<script src="config.js"></script>

<script>
const maxFiles = 3;
let filesArray = [];

const addFileBtn = document.getElementById("addFileBtn");
const fileContainer = document.getElementById("fileContainer");
const uploadBtn = document.getElementById("uploadBtn");

// Greet client
const params = new URLSearchParams(window.location.search);
const firstName = params.get("firstName") || "there";
const lastName  = params.get("lastName") || "";
const email     = params.get("email") || "";

document.getElementById("greeting").innerHTML =
  `<span>Hi ${firstName},</span>
   <span>Please upload up to ${maxFiles} files. You may add a note for each file.</span>`;

// Enable/disable upload button
function updateUploadButton() {
  uploadBtn.disabled = !filesArray.some(f => f.file instanceof File);
}

// Fade out element smoothly
function fadeOut(el, duration = 300) {
  el.style.transition = `opacity ${duration}ms`;
  el.style.opacity = 0;
  setTimeout(() => { el.style.display = "none"; }, duration);
}

// Create a file input row
function createFileInput(index) {
  const div = document.createElement("div");
  div.className = "file-item";
  div.style.display = "flex";
  div.style.flexDirection = "column";
  div.style.marginBottom = "1.5rem";

div.innerHTML = `
  <label>File ${index + 1}</label>
  <div style="display:flex; align-items:center; gap:10px;">
    <input type="file" class="form-control file-input mb-1" data-index="${index}" style="flex:1;">
    <img class="file-thumbnail" src="${filesArray[index].thumbnail || ''}" style="width:50px; height:50px; object-fit:cover; display:${filesArray[index].thumbnail ? 'inline-block' : 'none'}; border-radius:4px;">
  </div>
  <label class="note-label">Add a note for this file</label>
  <input type="text" class="form-control file-note" data-index="${index}" value="${filesArray[index].note || ''}">
  ${index > 0 ? `<button type="button" class="btn btn-sm btn-outline-danger removeFileBtn mt-2">Remove</button>` : ""}
  <div class="progress mt-2"><div class="progress-bar" style="width:0%">Waiting...</div></div>
`;

  fileContainer.appendChild(div);

  const fileInput = div.querySelector('input[type="file"]');
  const noteInput = div.querySelector('input[type="text"]');
  const fileNameSpan = div.querySelector(".file-name");
  const thumbnail = div.querySelector(".file-thumbnail");
  const removeBtn = div.querySelector(".removeFileBtn");

  // Handle file selection
  fileInput.addEventListener("change", e => {
    const file = e.target.files[0] || null;
    filesArray[index].file = file;

    if (file) {
      fileNameSpan.textContent = file.name;

      // Show thumbnail if image, else hide
      if (file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = ev => {
          thumbnail.src = ev.target.result;
          thumbnail.style.display = "inline-block";
        };
        reader.readAsDataURL(file);
      } else {
        thumbnail.src = "";
        thumbnail.style.display = "none";
      }
    } else {
      fileNameSpan.textContent = "";
      thumbnail.src = "";
      thumbnail.style.display = "none";
    }

    updateUploadButton();
  });

  // Note input
  noteInput.addEventListener("input", e => {
    filesArray[index].note = e.target.value;
  });

  // Remove button (2nd and 3rd slots)
  if (removeBtn) {
    removeBtn.addEventListener("click", () => {
      filesArray.splice(index, 1);
      refreshFileInputs();
    });
  }
}

// Re-render all file inputs
function refreshFileInputs() {
  fileContainer.innerHTML = "";
  filesArray.forEach((item, idx) => createFileInput(idx));

  if (filesArray.length < maxFiles) {
    addFileBtn.style.display = "inline-block";
    addFileBtn.style.opacity = 1;
  } else {
    fadeOut(addFileBtn);
  }

  updateUploadButton();
}

// Add File button click
addFileBtn.addEventListener("click", () => {
  if (filesArray.length < maxFiles) {
    filesArray.push({ file: null, note: "" });
    refreshFileInputs();
  }
});

// Upload files
uploadBtn.addEventListener("click", async () => {
  if (!filesArray.length || !filesArray.some(f => f.file)) {
    return showToast("Add at least one file.", "warning");
  }

  toggleLoader(true);
  const clientID = params.get("clientID") || "";

  for (let i = 0; i < filesArray.length; i++) {
    const { file, note } = filesArray[i];
    if (!file) continue;

    const progressBar = fileContainer.children[i].querySelector(".progress-bar");
    progressBar.style.width = "0%";
    progressBar.textContent = "Uploading...";

    let progress = 0;
    const interval = setInterval(() => {
      progress = Math.min(progress + 5, 95);
      progressBar.style.width = progress + "%";
    }, 100);

    try {
      const reader = new FileReader();
      await new Promise((resolve, reject) => {
        reader.onload = async e => {
          clearInterval(interval);
          progressBar.style.width = "95%";

          const base64Data = e.target.result.split(',')[1];
          const payload = {
            system: "clientUploads",
            action: "saveUploadedFiles",
            clientID,
            firstName,
            lastName,
            email,
            fileName: file.name,
            fileData: base64Data,
            fileNote: note
          };

          const res = await fetch(scriptURL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          let result;
          try { result = await res.json(); } 
          catch { result = { success: false, message: "Invalid JSON from server" }; }

          if (result.success) {
            progressBar.classList.add("bg-success");
            progressBar.style.width = "100%";
            progressBar.textContent = "File Uploaded ✓";
            showToast(`File "${file.name}" uploaded successfully!`, "success");
          } else {
            progressBar.classList.add("bg-danger");
            progressBar.style.width = "100%";
            progressBar.textContent = "Failed ❌";
            showToast(`Failed to upload file: ${file.name}`, "error");
          }
          resolve();
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    } catch (err) {
      clearInterval(interval);
      progressBar.classList.add("bg-danger");
      progressBar.style.width = "100%";
      progressBar.textContent = "Error ❌";
      showToast(`Error uploading file: ${file.name}`, "error");
    }
  }

  toggleLoader(false);
  showToast("Your files have been successfully uploaded. Thank you!", "success");
});

// Initialize with 1 file input
filesArray.push({ file: null, note: "" });
refreshFileInputs();

// Apply theme after DOM is ready
window.addEventListener('DOMContentLoaded', () => {
  const theme = localStorage.getItem('selectedTheme');
  if (theme) document.body.classList.add(theme);
});
</script>

</body>
</html>
