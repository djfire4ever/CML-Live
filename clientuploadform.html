<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Client File Upload</title>
  <style>
    .file-item { margin-bottom: 1rem; }
    .progress { height: 20px; }
    .file-note { color: var(--bs-info); }
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.8);
      z-index: 1050;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body class="page-body" style="min-height:100vh;" data-element="page-bg">
  <div class="watermark"></div>
  <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

  <!-- Loader -->
  <div id="loadingOverlay" class="d-none">
    <div class="text-center">
      <div class="spinner-border" role="status"></div>
      <p class="mt-4">Loading... Please wait...</p>
    </div>
  </div>

  <div class="container mt-4">
    <h3 id="greeting">Hi there, please upload up to 3 files. You may add a note for each file.</h3>

    <div id="fileContainer"></div>
    <button id="addFileBtn" class="btn btn-secondary mb-3">Add File</button>

    <div>
      <button id="uploadBtn" class="btn btn-primary" disabled>Upload Files</button>
    </div>
  </div>

  <script src="config.js"></script> <!-- This has all my glogal functions, variables and constants including scriptURL -->
  <script>
    const maxFiles = 3;
    let filesArray = [];

    const params = new URLSearchParams(window.location.search);
    const firstName = params.get("firstName") || "there";
    const lastName = params.get("lastName") || "";
    const email = params.get("email") || "";
    const clientID = params.get("clientID") || "";

    // Greet client
    document.getElementById("greeting").textContent =
      `Hi ${firstName}, please upload up to ${maxFiles} files. You may add a note for each file.`;

    // Enable/disable upload button
    function updateUploadButton() {
      document.getElementById("uploadBtn").disabled = !filesArray.some(f => f.file);
    }

    // Show toast
    function showToast(message, type="info") {
      const toast = document.createElement("div");
      toast.className = `toast align-items-center text-bg-${type} border-0 show mb-2`;
      toast.role = "alert";
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast" aria-label="Close"></button>
        </div>`;
      document.getElementById("toastContainer").appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    // Toggle loader
    function toggleLoader(show) {
      document.getElementById("loadingOverlay").classList.toggle("d-none", !show);
    }

    // Add new file input
    document.getElementById("addFileBtn").addEventListener("click", () => {
      if (filesArray.length >= maxFiles) {
        return showToast(`Max ${maxFiles} files allowed.`, "warning");
      }

      const index = filesArray.length;
      const div = document.createElement("div");
      div.className = "file-item";
      div.innerHTML = `
        <input type="file" class="form-control mb-1" data-index="${index}">
        <input type="text" class="form-control file-note" placeholder="Note for this file" data-index="${index}">
        <div class="progress mt-1"><div class="progress-bar" style="width:0%">Waiting...</div></div>
      `;
      document.getElementById("fileContainer").appendChild(div);

      filesArray.push({ file: null, note: "" });

      div.querySelector('input[type="file"]').addEventListener("change", (e) => {
        filesArray[index].file = e.target.files[0];
        updateUploadButton();
      });
      div.querySelector('input[type="text"]').addEventListener("input", (e) => {
        filesArray[index].note = e.target.value;
      });

      updateUploadButton();
    });

// Upload files button
document.addEventListener("DOMContentLoaded", () => {
  const uploadBtn = document.getElementById("uploadBtn");
  if (!uploadBtn) {
    console.error("üö® uploadBtn element not found in DOM.");
    return;
  }

  uploadBtn.addEventListener("click", async () => {
    console.log("üì§ Upload button clicked");

    // Get elements safely
    const fileInput = document.getElementById("fileInput");
    const noteInput = document.getElementById("fileNote");
    const clientIDEl = document.getElementById("clientID");
    const firstNameEl = document.getElementById("firstName");
    const lastNameEl = document.getElementById("lastName");
    const emailEl = document.getElementById("email");

    // Verify existence
    const requiredEls = { fileInput, noteInput, clientIDEl, firstNameEl, lastNameEl, emailEl };
    for (const [key, el] of Object.entries(requiredEls)) {
      if (!el) {
        console.error(`üö® Missing required element: ${key}`);
      }
    }

    if (!fileInput || !fileInput.files) {
      console.error("üö® fileInput missing or not usable.");
      return;
    }

    const files = fileInput.files;
    const fileNote = noteInput ? noteInput.value : "";
    console.log(`üìù File note: "${fileNote}"`);

    if (!files.length) {
      console.warn("‚ö†Ô∏è No file selected.");
      alert("Please select a file before uploading.");
      return;
    }

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      console.group(`üì¶ Uploading file #${i + 1}: ${file.name}`);

      console.log("üìë File object:", {
        name: file.name,
        size: file.size,
        type: file.type,
        lastModified: file.lastModified,
        lastModifiedDate: file.lastModifiedDate
      });

      try {
        const formData = new FormData();
        formData.append("system", "clientUploads");
        formData.append("action", "saveUploadedFiles");
        formData.append("clientID", clientIDEl ? clientIDEl.value : "");
        formData.append("firstName", firstNameEl ? firstNameEl.value : "");
        formData.append("lastName", lastNameEl ? lastNameEl.value : "");
        formData.append("email", emailEl ? emailEl.value : "");
        formData.append("fileNote", fileNote);
        formData.append("file", file);

        // üîé Inspect FormData entries
        console.log("üóÇÔ∏è FormData entries:");
        for (let [key, val] of formData.entries()) {
          if (val instanceof File) {
            console.log(`   ${key}: File { name: ${val.name}, size: ${val.size}, type: ${val.type} }`);
          } else {
            console.log(`   ${key}: ${val}`);
          }
        }

        // üß® Build multipart preview
        const boundary = "----WebKitFormBoundaryDEBUG";
        let multipartPreview = "";
        for (let [key, val] of formData.entries()) {
          multipartPreview += `--${boundary}\r\n`;
          if (val instanceof File) {
            multipartPreview += `Content-Disposition: form-data; name="${key}"; filename="${val.name}"\r\n`;
            multipartPreview += `Content-Type: ${val.type || "application/octet-stream"}\r\n\r\n`;
            multipartPreview += `[Binary content omitted: ${val.size} bytes]\r\n`;
          } else {
            multipartPreview += `Content-Disposition: form-data; name="${key}"\r\n\r\n${val}\r\n`;
          }
        }
        multipartPreview += `--${boundary}--`;
        console.log("üßæ Multipart Payload Preview:\n", multipartPreview);

        // üöÄ Send fetch
        console.log("üöÄ Sending fetch request‚Ä¶");
        const response = await fetch(YOUR_WEBAPP_URL, {
          method: "POST",
          body: formData
        });

        console.log("üì° Fetch completed.");
        console.log("   Status:", response.status, response.statusText);
        console.log("   Headers:", Object.fromEntries(response.headers.entries()));

        const rawText = await response.text();
        console.log("üìú Raw server response:", rawText);

        let parsed;
        try {
          parsed = JSON.parse(rawText);
          console.log("‚úÖ Parsed server response JSON:", parsed);
        } catch (err) {
          console.error("‚ùå Could not parse response as JSON:", err.message);
        }

        if (parsed && parsed.success) {
          console.log("üéâ Upload succeeded:", file.name);
        } else {
          console.error("‚ùå Upload failed:", file.name, parsed || rawText);
        }

      } catch (err) {
        console.error("üí• Upload error for file:", file.name, err);
      } finally {
        console.groupEnd();
      }
    }
  });
});

// Simulate a file upload entirely in-browser
async function testManualUpload() {
  console.log("üîπ Starting manual in-browser upload test");

  // Create a tiny test file in memory
  const testFile = new File(["Hello world from manual test!"], "manual-test.txt", {
    type: "text/plain"
  });

  // Fake note
  const testNote = "This is a manual test note";

  // Add file to your filesArray for uploadBtn loop
  const tempFilesArray = [{ file: testFile, note: testNote }];

  // Loop through files just like uploadBtn
  for (let i = 0; i < tempFilesArray.length; i++) {
    const { file, note } = tempFilesArray[i];
    console.group(`Manual test file #${i + 1}: ${file.name}`);
    console.log("File object:", file);
    console.log("File note:", note);

    const formData = new FormData();
    formData.append("system", "clientUploads");
    formData.append("action", "saveUploadedFiles");
    formData.append("clientID", "TEST-MANUAL-001");
    formData.append("firstName", "Felix");
    formData.append("lastName", "Client");
    formData.append("email", "felix@example.com");
    formData.append("fileNote", note);
    formData.append("file", file);

    // Debug: list FormData keys and values
    console.log("FormData keys/values:");
    for (let pair of formData.entries()) {
      console.log(pair[0], pair[1]);
    }

    try {
      const res = await fetch(scriptURL, {
        method: "POST",
        body: formData
      });

      console.log("Fetch completed, status:", res.status);
      const text = await res.text();
      console.log("Raw server response text:", text);

      let result;
      try {
        const firstBrace = text.indexOf("{");
        const lastBrace = text.lastIndexOf("}");
        if (firstBrace >= 0 && lastBrace >= 0) {
          const jsonStr = text.substring(firstBrace, lastBrace + 1);
          result = JSON.parse(jsonStr);
        } else {
          throw new Error("No JSON braces found in response");
        }
      } catch (err) {
        console.error("JSON parse error:", err, "Raw text:", text);
        result = { success: false, message: "Invalid JSON from server", details: err.message };
      }

      if (result.success) {
        console.log(`Manual test file "${file.name}" uploaded successfully!`, result);
      } else {
        console.error(`Manual test file "${file.name}" failed:`, result);
      }
    } catch (err) {
      console.error("Fetch error during manual test:", err);
    }

    console.groupEnd();
  }

  console.log("üîπ Manual in-browser upload test complete");
}

    // Apply theme
    window.addEventListener('DOMContentLoaded', () => {
      const theme = localStorage.getItem('selectedTheme');
      if (theme) document.body.classList.add(theme);
    });
  </script>
</body>
</html>
